<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSEB Fence Details - Live Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003f7f">
</head>
<body>
    <div class="app-container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <h1>Real-Time Monitoring</h1>
            <div class="subtitle">Live Fence Status</div>
        </div>

        <div class="dashboard">
            <div class="device-info" id="deviceInfo">
                <h2 id="fenceName">Loading...</h2>
                <div class="device-details">
                    <div class="detail-item">
                        <span class="label">Fence ID:</span>
                        <span class="value" id="fenceId">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Location:</span>
                        <span class="value" id="fenceLocation">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Owner:</span>
                        <span class="value" id="fenceOwner">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Contact:</span>
                        <span class="value" id="fenceContact">-</span>
                    </div>
                </div>
            </div>

            <div class="status-card critical" id="statusCard">
                <div class="status-header">
                    <h3>Current Status</h3>
                    <span class="status-badge" id="statusBadge">CRITICAL</span>
                </div>
                <div class="alert-message" id="alertMessage">
                    Current exceeds 13A safety threshold!
                </div>
                <div class="notification-sent">
                    ‚úì Emergency notification sent to KSEB officials
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Current Reading</span>
                        <span class="metric-unit">Amperes</span>
                    </div>
                    <div class="metric-value" id="currentReading">14.7A</div>
                    <div class="metric-trend" id="currentTrend">‚Üë +2.3A from average</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Voltage Level</span>
                        <span class="metric-unit">Volts</span>
                    </div>
                    <div class="metric-value" id="voltageReading">8.3V</div>
                    <div class="metric-trend" id="voltageTrend">‚Üí Stable</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Daily Peak</span>
                        <span class="metric-unit">Amperes</span>
                    </div>
                    <div class="metric-value" id="dailyPeak">15.2A</div>
                    <div class="metric-trend" id="peakTime">at 14:23 IST</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Last Updated</span>
                        <span class="metric-unit">Time</span>
                    </div>
                    <div class="metric-value" id="lastUpdated">Now</div>
                    <div class="metric-trend">Live monitoring active</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Real-Time Data Visualization</h3>
                <div class="chart-placeholder" id="chartArea">
                    <canvas id="currentChart" width="350" height="200"></canvas>
                    <div class="chart-info">
                        <p>üìä Real-time data visualization showing current fluctuations</p>
                        <p>üî¥ Red line indicates safety threshold (13A)</p>
                        <p>üìà Chart updates every 5 seconds</p>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="history-container" id="historyContainer" style="display: none;">
                <h3>üìä Historical Data</h3>
                <div class="history-controls">
                    <select id="historyPeriod" onchange="filterHistory()">
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                    </select>
                </div>
                <div class="history-table-container">
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Current (A)</th>
                                <th>Voltage (V)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Historical data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="safety-info">
                <h3>‚ö†Ô∏è Safety Information</h3>
                <ul>
                    <li><strong>Normal Range:</strong> 0-11 Amperes</li>
                    <li><strong>Warning Range:</strong> 11-13 Amperes</li>
                    <li><strong>Critical Range:</strong> Above 13 Amperes</li>
                    <li><strong>Emergency Contact:</strong> KSEB Control Room: 1912</li>
                    <li><strong>Sound Alert:</strong> Activated automatically for critical status</li>
                </ul>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshData()">
                    üîÑ Refresh Data
                </button>
                <button class="btn btn-secondary" onclick="downloadReport()">
                    üìÑ Download Report
                </button>
                <button class="btn btn-info" onclick="toggleHistory()">
                    üìä View History
                </button>
                <button class="btn btn-success" onclick="exportData()">
                    üíæ Export Data
                </button>
                <button class="btn btn-danger" onclick="reportEmergency()">
                    üö® Report Emergency
                </button>
            </div>
        </div>

        <footer class="footer">
            <p>&copy; 2025 Kerala State Electricity Board Limited</p>
            <p>Smart India Hackathon 2025 - Live Monitoring System</p>
        </footer>
    </div>

    <!-- AI Chatbot Widget -->
    <div class="chat-widget" id="chatWidget">
        <div class="chat-bubble" id="chatBubble">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
        </div>
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-title">
                    <h3>KSEB AI Assistant</h3>
                    <p>Ask me about this fence</p>
                </div>
                <div class="chat-controls">
                    <button class="minimize-btn" id="minimizeBtn">‚àí</button>
                    <button class="close-btn" id="closeBtn">√ó</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-content">
                        Hello! I can help you understand this fence's current readings, explain the alert status, and provide safety guidance. What would you like to know?
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span>AI is thinking...</span>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Ask me about this fence..." />
                    <button id="sendBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // KSEB Enhanced Monitoring System with Original Sound Implementation
        class KSEBDetailedMonitoringSystem {
            constructor() {
                this.historyData = [];
                this.isHistoryVisible = false;
                this.currentFence = null;
                this.init();
                this.generateSampleHistory();
            }

            init() {
                this.loadSelectedFenceDetails();
                this.drawChart();
                this.initChatbot();
                this.startRealTimeUpdates();
            }

            // EXACT SOUND IMPLEMENTATION FROM ORIGINAL FILE
            playAlertSound() {
                // Create simple alert beep
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1);
                } catch (error) {
                    console.log('Audio not available');
                }
            }

            loadSelectedFenceDetails() {
                const selectedFenceId = localStorage.getItem('selectedFenceId') || 'KSEB002';
                const fenceData = this.getFenceData();
                const fence = fenceData.find(f => f.id === selectedFenceId);
                
                if (!fence) return;

                this.currentFence = fence;

                // Update all details page elements
                this.updateElement('fenceName', fence.name);
                this.updateElement('fenceId', fence.id);
                this.updateElement('fenceLocation', fence.location);
                this.updateElement('fenceOwner', fence.owner);
                this.updateElement('fenceContact', fence.contact);
                this.updateElement('currentReading', `${fence.current}A`);
                this.updateElement('voltageReading', `${fence.voltage}V`);
                this.updateElement('dailyPeak', `${fence.dailyPeak}A`);
                this.updateElement('lastUpdated', 'Now');

                // Update status card and trigger sound alert
                const statusCard = document.getElementById('statusCard');
                const statusBadge = document.getElementById('statusBadge');
                const alertMessage = document.getElementById('alertMessage');

                if (statusCard && statusBadge && alertMessage) {
                    statusCard.className = `status-card ${fence.status}`;
                    statusBadge.textContent = fence.status.toUpperCase();
                    
                    if (fence.status === 'critical') {
                        alertMessage.textContent = `Current exceeds 13A safety threshold!`;
                        // Play alert sound - EXACTLY like the original
                        this.playAlertSound();
                    } else if (fence.status === 'warning') {
                        alertMessage.textContent = `Current approaching safety threshold (${fence.current}A/13A)`;
                    } else {
                        alertMessage.textContent = 'Electric fence operating within safe parameters';
                    }
                }

                // Update trends
                this.updateElement('currentTrend', this.calculateTrend(fence.current, fence.dailyPeak));
                this.updateElement('voltageTrend', '‚Üí Stable');
                this.updateElement('peakTime', 'at 14:23 IST');
            }

            getFenceData() {
                return [
                    {
                        id: "KSEB001", name: "Thiruvananthapuram Central", location: "TVM District Office",
                        current: 11.2, voltage: 8.5, status: "normal", dailyPeak: 12.1,
                        owner: "District Collector Office", contact: "91-471-2345678"
                    },
                    {
                        id: "KSEB002", name: "Kochi Industrial Zone", location: "Kakkanad IT Park",
                        current: 14.7, voltage: 8.3, status: "critical", dailyPeak: 15.2,
                        owner: "IT Park Authority", contact: "91-484-2345678"
                    },
                    {
                        id: "KSEB003", name: "Kozhikode Beach Road", location: "Beach Road Substation",
                        current: 9.8, voltage: 8.7, status: "normal", dailyPeak: 11.3,
                        owner: "Tourism Department", contact: "91-495-2345678"
                    },
                    {
                        id: "KSEB004", name: "Thrissur Cultural Center", location: "Swaraj Round",
                        current: 12.9, voltage: 8.4, status: "warning", dailyPeak: 13.4,
                        owner: "Cultural Affairs Dept", contact: "91-487-2345678"
                    },
                    {
                        id: "KSEB005", name: "Kollam Port Authority", location: "Kollam Port Complex",
                        current: 10.5, voltage: 8.6, status: "normal", dailyPeak: 11.8,
                        owner: "Port Trust", contact: "91-474-2345678"
                    },
                    {
                        id: "KSEB006", name: "Palakkad Railway Junction", location: "Railway Station Perimeter",
                        current: 13.2, voltage: 8.2, status: "warning", dailyPeak: 13.8,
                        owner: "Indian Railways", contact: "91-491-2345678"
                    },
                    {
                        id: "KSEB007", name: "Malappuram Govt Complex", location: "District Collectorate",
                        current: 8.7, voltage: 8.8, status: "normal", dailyPeak: 10.2,
                        owner: "District Administration", contact: "91-483-2345678"
                    },
                    {
                        id: "KSEB008", name: "Kannur Airport Perimeter", location: "International Airport",
                        current: 11.8, voltage: 8.4, status: "normal", dailyPeak: 12.5,
                        owner: "Airport Authority", contact: "91-497-2345678"
                    },
                    {
                        id: "KSEB009", name: "Wayanad Tourist Center", location: "Vythiri Resort Area",
                        current: 7.9, voltage: 8.9, status: "normal", dailyPeak: 9.1,
                        owner: "Forest Department", contact: "91-493-2345678"
                    },
                    {
                        id: "KSEB010", name: "Idukki Dam Security", location: "Dam Perimeter Fence",
                        current: 12.4, voltage: 8.3, status: "normal", dailyPeak: 13.1,
                        owner: "Dam Authority", contact: "91-486-2345678"
                    }
                ];
            }

            generateSampleHistory() {
                const now = new Date();
                this.historyData = [];
                
                // Generate 24 hours of sample data
                for (let i = 0; i < 24; i++) {
                    const time = new Date(now.getTime() - (i * 60 * 60 * 1000));
                    const baseCurrent = 12 + Math.sin(i * 0.5) * 3;
                    const current = (baseCurrent + (Math.random() - 0.5) * 2).toFixed(1);
                    const voltage = (8.5 + (Math.random() - 0.5) * 0.5).toFixed(1);
                    const status = current > 13 ? 'critical' : current > 11 ? 'warning' : 'normal';
                    
                    this.historyData.push({
                        time: time.toLocaleString(),
                        current: parseFloat(current),
                        voltage: parseFloat(voltage),
                        status: status
                    });
                }
            }

            calculateTrend(current, peak) {
                const diff = (current - (peak * 0.8)).toFixed(1);
                if (diff > 0) {
                    return `‚Üë +${diff}A from average`;
                } else if (diff < 0) {
                    return `‚Üì ${diff}A from average`;
                } else {
                    return '‚Üí At average level';
                }
            }

            drawChart() {
                const canvas = document.getElementById('currentChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                ctx.clearRect(0, 0, width, height);

                // Generate data points
                const dataPoints = [];
                const selectedFenceId = localStorage.getItem('selectedFenceId') || 'KSEB002';
                const baseCurrent = this.getFenceData().find(f => f.id === selectedFenceId)?.current || 14.7;
                
                for (let i = 0; i < 50; i++) {
                    const variation = (Math.random() - 0.5) * 2;
                    dataPoints.push(baseCurrent + variation);
                }

                // Draw grid
                ctx.strokeStyle = '#e9ecef';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= 10; i++) {
                    const y = (height / 10) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }

                for (let i = 0; i <= 10; i++) {
                    const x = (width / 10) * i;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }

                // Draw threshold line
                const thresholdY = height - (13 / 20) * height;
                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(0, thresholdY);
                ctx.lineTo(width, thresholdY);
                ctx.stroke();
                ctx.setLineDash([]);

                // Draw data line
                ctx.strokeStyle = '#003f7f';
                ctx.lineWidth = 3;
                ctx.beginPath();

                dataPoints.forEach((point, index) => {
                    const x = (width / (dataPoints.length - 1)) * index;
                    const y = height - (point / 20) * height;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();

                // Draw current point
                const currentX = width - (width / (dataPoints.length - 1));
                const currentY = height - (baseCurrent / 20) * height;
                ctx.fillStyle = baseCurrent > 13 ? '#dc3545' : '#003f7f';
                ctx.beginPath();
                ctx.arc(currentX, currentY, 6, 0, 2 * Math.PI);
                ctx.fill();
            }

            updateElement(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            }

            startRealTimeUpdates() {
                setInterval(() => {
                    // Simulate real-time data changes
                    if (this.currentFence) {
                        const variation = (Math.random() - 0.5) * 0.2;
                        this.currentFence.current = Math.max(0, this.currentFence.current + variation);
                        this.currentFence.voltage = Math.max(0, Math.min(10, this.currentFence.voltage + (Math.random() - 0.5) * 0.1));
                        
                        // Update status based on current
                        if (this.currentFence.current > 13) {
                            this.currentFence.status = 'critical';
                        } else if (this.currentFence.current > 11) {
                            this.currentFence.status = 'warning';
                        } else {
                            this.currentFence.status = 'normal';
                        }
                    }
                    
                    this.loadSelectedFenceDetails();
                    this.drawChart();
                }, 5000);
            }

            initChatbot() {
                // Chatbot initialization would go here
                // Using the same chatbot code from previous implementation
            }
        }

        // Global functions
        function goBack() {
            window.location.href = 'index.html';
        }

        function refreshData() {
            window.location.reload();
        }

        function downloadReport() {
            const selectedFenceId = localStorage.getItem('selectedFenceId') || 'KSEB002';
            const fence = monitoringSystem.getFenceData().find(f => f.id === selectedFenceId);
            
            const reportContent = `
KSEB Electric Fence Monitoring Report
Generated: ${new Date().toLocaleString()}

Fence Details:
- ID: ${fence.id}
- Name: ${fence.name}
- Location: ${fence.location}
- Owner: ${fence.owner}
- Contact: ${fence.contact}

Current Status:
- Current Reading: ${fence.current}A
- Voltage Level: ${fence.voltage}V
- Status: ${fence.status.toUpperCase()}
- Daily Peak: ${fence.dailyPeak}A

Safety Information:
- Normal Range: 0-11 Amperes
- Warning Range: 11-13 Amperes
- Critical Range: Above 13 Amperes
- Emergency Contact: KSEB Control Room: 1912
            `;

            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `KSEB_Fence_Report_${selectedFenceId}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function exportData() {
            const csvContent = monitoringSystem.historyData.map(row => 
                `${row.time},${row.current},${row.voltage},${row.status}`
            ).join('\\n');

            const header = 'Time,Current (A),Voltage (V),Status\\n';
            const fullCsv = header + csvContent;

            const blob = new Blob([fullCsv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `KSEB_Fence_Data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('Fence data exported successfully!');
        }

        function toggleHistory() {
            const historyContainer = document.getElementById('historyContainer');
            const button = event.target;
            
            if (monitoringSystem.isHistoryVisible) {
                historyContainer.style.display = 'none';
                button.innerHTML = 'üìä View History';
                monitoringSystem.isHistoryVisible = false;
            } else {
                historyContainer.style.display = 'block';
                button.innerHTML = 'üìä Hide History';
                monitoringSystem.isHistoryVisible = true;
                loadHistoryTable();
            }
        }

        function loadHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = monitoringSystem.historyData.map(row => `
                <tr class="status-${row.status}">
                    <td>${row.time}</td>
                    <td>${row.current}A</td>
                    <td>${row.voltage}V</td>
                    <td><span class="status-badge ${row.status}">${row.status.toUpperCase()}</span></td>
                </tr>
            `).join('');
        }

        function filterHistory() {
            // History filtering logic would go here
            loadHistoryTable();
        }

        function reportEmergency() {
            alert('Emergency reported to KSEB Control Room!\\nEmergency Hotline: 1912');
        }

        // Initialize the monitoring system
        let monitoringSystem;
        document.addEventListener('DOMContentLoaded', function() {
            monitoringSystem = new KSEBDetailedMonitoringSystem();
        });
    </script>

    <style>
        /* Additional styles for new features */
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .history-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .history-controls {
            margin-bottom: 15px;
        }
        
        .history-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .history-table-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th,
        .history-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .status-critical {
            background: #f8d7da;
        }
        
        .status-warning {
            background: #fff3cd;
        }
        
        .status-normal {
            background: #d4edda;
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.normal {
            background: #d4edda;
            color: #155724;
        }
    </style>
</body>
</html>